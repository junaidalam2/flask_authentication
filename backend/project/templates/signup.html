{% extends "base.html" %}

{% block content %}
<div class="column is-6 is-offset-3">
    <h3 class="title has-text-centered">Sign Up</h3>
    <div class="box">

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="notification is-{{ category }}">
            {{ messages[0] }}
        </div>
        {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('auth.signup_post') }}">
            <div class="field">
                <label class="label">Email<span>*</span></label>
                <div class="control">
                    <input class="input" type="email" id="email" name="email" placeholder="Email" required>
                </div>
                <p class="help is-danger" id="email_help" style="display:none;">Invalid email format.</p>
            </div>

            <div class="field">
                <label class="label">
                    Password<span>*</span>
                </label>
                <div class="control">
                    <input class="input" type="password" id="password" name="password" placeholder="Password" required>
                </div>
            </div>

            <div class="field">
                <label class="label">Confirm Password<span>*</span></label>
                <input class="input" type="password" id="confirm_password" name="confirm_password"
                    placeholder="Re-enter your password" minlength="6" required>
                <span class="icon is-small is-left">
                    <i class="fas fa-lock"></i>
                </span>
                <p class="help is-danger" id="password_help" style="display:none;">Passwords do not match.</p>
            </div>

            <div class="columns">
                <div class="column">
                    <div class="field">
                        <label class="label">
                            First Name<span>*</span>
                        </label>
                        <div class="control">
                            <input class="input" type="text" name="first_name" placeholder="First Name" required>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="field">
                        <label class="label">
                            Last Name<span>*</span>
                        </label>
                        <div class="control">
                            <input class="input" type="text" name="last_name" placeholder="Last Name" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="field">
                <label class="label">
                    Title<span>*</span>
                </label>
                <div class="control">
                    <input class="input" type="text" name="title" placeholder="Job Title" required>
                </div>
            </div>

            <div class="field">
                <label class="label">
                    Company Name<span>*</span>
                </label>
                <div class="control">
                    <input class="input" type="text" name="company_name" placeholder="Company Name" required>
                </div>
            </div>

            <div class="field">
                <label class="label">Country<span>*</span></label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select name="country" id="country" required>
                            <option value="">Select your country</option>
                            {% for code, name in countries %}
                            <option value="{{ name }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="field">
                <label class="label">
                    Street Address<span>*</span>
                    <div class="control">
                        <input class="input" type="text" name="street_address" placeholder="Street Address" required>
                    </div>
            </div>

            <div class="field">
                <label class="label">Street Address Line 2</label>
                <div class="control">
                    <input class="input" type="text" name="street_address_line2"
                        placeholder="Apartment, suite, etc. (optional)">
                </div>
            </div>

            <div class="columns">
                <div class="column">
                    <div class="field">
                        <label class="label">City<span>*</span></label>
                        <div class="control">
                            <input class="input" type="text" name="city" required>
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="field">
                        <label class="label">State / Province / Region<span>*</span></label>
                        <div class="control">
                            <input class="input" name="state_province_region" id="state_province_region"
                                list="state_list" placeholder="Select or type your subdivision" required>
                            <datalist id="state_list"></datalist>
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="field">
                        <label class="label">Postal Code<span>*</span></label>
                        <div class="control">
                            <input class="input" type="text" name="postal_code" placeholder="Postal Code" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="columns">
                <div class="column is-two-thirds">
                    <div class="field">
                        <label class="label">Phone Number<span>*</span></label>
                        <div class="control">
                            <input class="input" type="tel" name="phone" placeholder="+1 555 123 4567" required>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="field">
                        <label class="label">Phone Type<span>*</span></label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select name="phone_type" required>
                                    <option value="">Select type</option>
                                    <option value="mobile">Mobile</option>
                                    <option value="work">Work</option>
                                    <option value="home">Home</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="button is-block is-info is-large is-fullwidth">Sign Up</button>
        </form>

        <p class="has-text-centered mt-3">
            Already have an account?
            <a href="{{ url_for('auth.login') }}">Log in</a>
        </p>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", () => {
        const password = document.getElementById("password");
        const confirm = document.getElementById("confirm_password");
        const help = document.getElementById("password_help");

        // Instant password match validation
        const validatePasswords = () => {
            if (confirm.value && confirm.value !== password.value) {
                confirm.classList.add("is-danger");
                help.style.display = "block";
            } else {
                confirm.classList.remove("is-danger");
                help.style.display = "none";
            }
        };
        password.addEventListener("input", validatePasswords);
        confirm.addEventListener("input", validatePasswords);

        // Subdivision datalist population
        const countrySelect = document.getElementById("country");
        const stateList = document.getElementById("state_list");

        const subdivisions = {{ subdivisions | tojson | safe
    }};

    countrySelect.addEventListener("change", () => {
        const selectedCountry = countrySelect.value;
        const states = subdivisions[selectedCountry] || [];

        stateList.innerHTML = '';
        states.forEach(s => {
            const option = document.createElement("option");
            option.value = s.name;
            stateList.appendChild(option);
        });
    });
    });
</script>

{% endblock %}